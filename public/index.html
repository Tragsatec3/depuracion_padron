<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Salamanca</title>

  <!-- CSS de Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Proj4js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.4/proj4.js"></script>
  <script src="https://unpkg.com/leaflet-plugins/layer/tile/Google.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Datos geográficos -->
  <script type="text/javascript" src="prov.js"></script>
  <script type="text/javascript" src="muni.js"></script>

  <!-- CSS personalizado -->
  <style>
    /* Estilo para el mapa */
    #map { 
      height: 800px; 
      width: 80%; 
    }

    /* Estilo para el cuadro de coordenadas */
    #coordinates {
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      padding: 10px;
      position: fixed;
      top: 10px;
      right: 20px;
      z-index: 1000;
    }

    /* Estilo para el botón de copiar X */
    #copyButton {
      margin-top: 10px;
      cursor: pointer;
      padding: 5px 10px;
      background-color: rgb(53, 9, 248);
      color: white;
      border: none;
      border-radius: 5px;
    }

    /* Estilo para el botón de copiar Y */
    #copyYButton {
      margin-left: 70px;
    }

    /* Estilo para el título */
    h1 {
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Cuadro de coordenadas -->
  <div id="coordinates">
    <p><strong>Coordenadas del ratón:</strong></p>
    <p>ETRS89</p>
    <p id="etrs">X=<span id="xCoord"></span>, Y=<span id="yCoord"></span></p>
    <button class="copyButton" id="copyXButton">Copiar X</button>
    <button class="copyButton" id="copyYButton">Copiar Y</button>
  </div>

  <!-- JavaScript embebido -->
  <script>
    $(document).ready(function () {
        // Obtener parámetros de la URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const lat = parseFloat(getQueryParam('lat')) || 41.6644;
        const lng = parseFloat(getQueryParam('lng')) || -2.5458;
        const x = parseFloat(getQueryParam('x'));
        const y = parseFloat(getQueryParam('y'));
        const zoom = parseInt(getQueryParam('zoom')) || 9;

        let map;
        let frozenCoords = false;

        if (!isNaN(x) && !isNaN(y)) {
            var wgsCoords = proj4('+proj=utm +zone=30 +datum=ETRS89 +units=m +no_defs', 'EPSG:4326', [x, y]);
            map = L.map('map').setView([wgsCoords[1], wgsCoords[0]], zoom);
        } else {
            map = L.map('map').setView([lat, lng], zoom);
        }

        // Capas base
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 40,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var googleLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=m&hl=es&z={z}&x={x}&y={y}', {
            maxZoom: 40,
            attribution: '&copy; Google Maps'
        });

        var pnoaLayer = L.tileLayer('https://tms-pnoa-ma.idee.es/1.0.0/pnoa-ma/{z}/{x}/{-y}.jpeg', {
            maxZoom: 19,
            attribution: 'CC BY 4.0 scne.es'
        });

        var catastroLayer = L.tileLayer.wms("https://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx?", {
            layers: 'Catastro',
            format: 'image/png',
            transparent: true,
            version: '1.1.1',
            attribution: "DIRECCION GENERAL DEL CATASTRO",
            maxZoom: 40
        });

        var callejero = L.tileLayer.wms('https://www.ign.es/wms-inspire/ign-base?', {
            layers: 'IGNBaseTodo',
            format: 'image/png',
            maxZoom: 40,
            transparent: true,
            attribution: '© Instituto Geográfico Nacional'
        });

        // Capas de Provincias y Municipios
        var provincias = L.geoJson(prov, { style: { "color": "#EB5B00", "weight": 4, "opacity": 0.8 } }).addTo(map);
        var municipios = L.geoJson(muni, {
            style: { "color": "#3182bd", "weight": 1, "opacity": 3.5 },
            onEachFeature: function (feature, layer) {
                if (feature.properties && feature.properties.D_MUN) {
                    layer.bindTooltip(feature.properties.D_MUN, { permanent: false, direction: "top" });
                }
            }
        }).addTo(map);

        // Control de capas
        var baseMaps = { "Callejero": callejero, "Google Maps": googleLayer, "Open Street Map": osmLayer, "Catastro": catastroLayer, "Imagen PNOA": pnoaLayer };
        var overlayMaps = { "Provincias": provincias, "Municipios": municipios };

        L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);
        L.control.scale({ metric: true, imperial: false }).addTo(map);

        // Obtener información catastral al hacer clic
        map.on('click', function (e) {
            const url = `/api/proxy?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=Catastro&QUERY_LAYERS=Catastro&INFO_FORMAT=text/xml&SRS=EPSG:4326&BBOX=${map.getBounds().toBBoxString()}&WIDTH=${map.getSize().x}&HEIGHT=${map.getSize().y}&X=${Math.floor(e.containerPoint.x)}&Y=${Math.floor(e.containerPoint.y)}`;

            fetch(url)
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(data, "text/xml");

                    const enlace = xmlDoc.getElementsByTagName("a")[0];
                    const referenciaCatastral = enlace?.textContent || "No disponible";

                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(`<strong>Referencia catastral:</strong> <a href="#" target="_blank">${referenciaCatastral}</a>`)
                        .openOn(map);
                })
                .catch(error => console.error('Error en GetFeatureInfo:', error));
        });

        // Copiar coordenadas
        $('#copyXButton').on('click', function () {
            navigator.clipboard.writeText($('#xCoord').text()).then(() => alert('X copiada!'));
        });

        $('#copyYButton').on('click', function () {
            navigator.clipboard.writeText($('#yCoord').text()).then(() => alert('Y copiada!'));
        });
    });
  </script>

</body>
</html>
